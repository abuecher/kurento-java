function KurentoTest(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,this.x=0,this.y=0,this.colorInfo={},this.maxColorDistance=60,this.colorCheckRate=10,this.latencyVideoTagsId=null,this.latencyTime={},this.latency=0,this.firstLatency=!0,this.rtcStats={},this.rtcStatsInterval=100,this.rtcStatsIntervalIds={},this.initTime=new Date,this.sync=!1,this.syncTime=null,this.ocrActive=!1,this.ocrMap={},this.recordRTC=null,this.recordingData,this.videoEventValue=null}KurentoTest.prototype.syncTimeForOcr=function(e,t){var o=(new Date).getTime();this.syncTime=new Date(o+6e4),this.syncTime.setSeconds(0),this.syncTime.setMilliseconds(0);var n=this.syncTime.getTime()-o;console.info("Time wait for next exact minute: "+n+" ms");var r=this;setTimeout(function(){console.info("Sync finished"),r.sync=!0;var o=(new Date).getTime();r.getVideoTime(e,o),r.getStats(t,o),setInterval(function(){var o=(new Date).getTime();r.getVideoTime(e,o),r.getStats(t,o)},1e3)},n)},KurentoTest.prototype.startOcr=function(){console.info("Starting OCR"),this.ocrActive=!0},KurentoTest.prototype.endOcr=function(){console.info("Ending OCR"),this.ocrActive=!1},KurentoTest.prototype.getStats=function(peerConnectionId,time){if(this.ocrActive){var peerConnection=eval(peerConnectionId);eval("var localStream = peerConnection.getLocalStreams()[0];"),eval("var remoteStream = peerConnection.getRemoteStreams()[0];");var localVideoTrack=localStream?localStream.getVideoTracks()[0]:null,localAudioTrack=localStream?localStream.getAudioTracks()[0]:null,remoteVideoTrack=remoteStream?remoteStream.getVideoTracks()[0]:null,remoteAudioTrack=remoteStream?remoteStream.getAudioTracks()[0]:null;for(var key in localStream?(kurentoTest.updateStats(peerConnection,localAudioTrack,"localAudio"),kurentoTest.updateStats(peerConnection,localVideoTrack,"localVideo")):remoteStream&&(kurentoTest.updateStats(peerConnection,remoteAudioTrack,"remoteAudio"),kurentoTest.updateStats(peerConnection,remoteVideoTrack,"remoteVideo")),this.rtcStats)this.ocrMap[time][key]=this.rtcStats[key]}},KurentoTest.prototype.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},KurentoTest.prototype.getVideoTime=function(e,t){if(this.ocrActive){var o=document.getElementById(e),n=document.createElement("canvas"),r=n.getContext("2d");n.width=440,n.height=61,r.drawImage(o,40,15,440,61,0,0,440,61);var a=n.toDataURL("image/png").replace("image/png","image/octet-stream");this.ocrMap[t]={E2ELatencyMs:a}}},KurentoTest.prototype.checkColor=function(){for(var e=0;e<arguments.length;e++)this.checkColorIn(arguments[e])},KurentoTest.prototype.checkColorIn=function(e){var t=document.getElementById(e);if(t){var o=document.createElement("canvas");o.width=1,o.height=1;var n=o.getContext("2d");t.crossOrigin="anonymous",this.colorInfo[e]={},this.colorInfo[e].changeColor=[0,0,0,0],this.colorInfo[e].currentColor=null,this.colorInfo[e].changeTime=null;var r=this;requestAnimationFrame(function o(){try{n.drawImage(t,r.x,r.y,1,1,0,0,1,1)}catch(e){if("NS_ERROR_NOT_AVAILABLE"!=e.name)throw e}var a=Array.prototype.slice.apply(n.getImageData(0,0,1,1).data);r.colorInfo[e].currentColor=a,document.getElementById(e+"-color")&&(document.getElementById(e+"-color").value=a),requestAnimationFrame(o)}),setInterval(function(){if(r.colorChanged(r.colorInfo[e].currentColor,r.colorInfo[e].changeColor)&&(r.colorInfo[e].changeTime=new Date-r.initTime,console.info("Detected color change in "+e+" stream, from "+r.colorInfo[e].changeColor+" to "+r.colorInfo[e].currentColor),r.colorInfo[e].changeColor=r.colorInfo[e].currentColor,null!=r.latencyVideoTagsId&&e==r.latencyVideoTagsId[1]&&r.firstLatency?r.firstLatency=!1:r.latencyTime[e]=r.colorInfo[e].changeTime,null!=r.latencyVideoTagsId&&r.latencyTime[r.latencyVideoTagsId[0]]&&r.latencyTime[r.latencyVideoTagsId[1]])){r.latencyTime={};var t=r.colorInfo[r.latencyVideoTagsId[1]].changeTime-r.colorInfo[r.latencyVideoTagsId[0]].changeTime;r.latency=t,console.info("---\x3e Latency "+r.latency)}},this.colorCheckRate)}},KurentoTest.prototype.activateLatencyControl=function(e,t){this.latencyTime={},this.latencyVideoTagsId=[e,t]},KurentoTest.prototype.getLatency=function(){var e=this.latency;return this.latency=null,e},KurentoTest.prototype.getDataChannelState=function(){return document.getElementById("datachannel-state").value},KurentoTest.prototype.getDataChannelMessage=function(){return document.getElementById("datachannel-received").value},KurentoTest.prototype.colorChanged=function(e,t){if(e&&t){var o=t[0],n=t[1],r=t[2],a=e[0],i=e[1],c=e[2];return Math.sqrt((o-a)*(o-a)+(n-i)*(n-i)+(r-c)*(r-c))>this.maxColorDistance}return!1},KurentoTest.prototype.activateOutboundRtcStats=function(e){this.activateRtcStats(e,"getLocalStreams","_outbound_")},KurentoTest.prototype.activateInboundRtcStats=function(e){this.activateRtcStats(e,"getRemoteStreams","_inbound_")},KurentoTest.prototype.activateRtcStats=function(peerConnectionVarName,functionName,suffix){const rtcStatsName=""+peerConnectionVarName+functionName+suffix;kurentoTest.rtcStatsIntervalIds[rtcStatsName]=setInterval(this.updateRtcStats,this.rtcStatsInterval,eval(peerConnectionVarName),functionName,suffix)},KurentoTest.prototype.updateRtcStats=function(peerConnection,streamFnName,suffix){eval("var pcStream = peerConnection."+streamFnName+"()[0];");const audioTrack=pcStream.getAudioTracks()[0];audioTrack&&kurentoTest.updateStats(peerConnection,audioTrack,"audio_peerconnection"+suffix);const videoTrack=pcStream.getVideoTracks()[0];videoTrack&&kurentoTest.updateStats(peerConnection,videoTrack,"video_peerconnection"+suffix)},KurentoTest.prototype.updateStats=function(e,t,o){e.getStats(t).then(function(e){e.forEach(e=>{"inbound-rtp"!==e.type&&"outbound-rtp"!==e.type||Object.keys(e).forEach(t=>{if("type"!==t&&"id"!==t){const n=o+t;kurentoTest.rtcStats[n]=e[t]}})})}).catch(function(e){console.error("Error on peerConnection.getStats(): "+e)})},KurentoTest.prototype.stopOutboundRtcStats=function(e){this.clearRtcStatsInterval(e,"getLocalStreams","_outbound_")},KurentoTest.prototype.stopInboundRtcStats=function(e){this.clearRtcStatsInterval(e,"getRemoteStreams","_inbound_")},KurentoTest.prototype.clearRtcStatsInterval=function(e,t,o){const n=""+e+t+o;clearInterval(kurentoTest.rtcStatsIntervalIds[n]),this.rtcStats={}},KurentoTest.prototype.setMaxColorDistance=function(e){this.maxColorDistance=e},KurentoTest.prototype.setColorCoordinates=function(e,t){this.x=e,this.y=t},KurentoTest.prototype.setColorCheckRate=function(e){this.colorCheckRate=e},KurentoTest.prototype.startRecording=function(e,t,o){var n="video/webm";"mp4"===o&&(n="video/mp4");var r="record-audio-and-video";if(t&&(r=t),"record-video"===r){var a={type:"video",mimeType:isChrome?null:n,disableLogs:!1,canvas:{width:320,height:240},frameInterval:20};this.recordRTC=RecordRTC(e,a),this.recordRTC.startRecording()}if("record-audio"===r){a={type:"audio",mimeType:n,bufferSize:0,sampleRate:44100,leftChannel:!1,disableLogs:!1,recorderType:StereoAudioRecorder};this.recordRTC=RecordRTC(e,a),this.recordRTC.startRecording()}if("record-audio-and-video"===r){if("undefined"==typeof MediaRecorder){this.recordRTC=[];var i={type:"audio",bufferSize:16384,sampleRate:44100,leftChannel:!1,disableLogs:!1,recorderType:StereoAudioRecorder},c=RecordRTC(e,i),s=RecordRTC(e,{type:"video",disableLogs:!1,canvas:{width:320,height:240},frameInterval:20});return s.initRecorder(function(){c.initRecorder(function(){c.startRecording(),s.startRecording()})}),void this.recordRTC.push(c,s)}a={type:"video",mimeType:isChrome?null:n,disableLogs:!1,getNativeBlob:!0};this.recordRTC=RecordRTC(e,a),this.recordRTC.startRecording()}},KurentoTest.prototype.stopRecording=function(){this.recordRTC?this.recordRTC.length?this.recordRTC[0].stopRecording(function(e){this.recordRTC[1]?this.recordRTC[1].stopRecording(function(e){console.info("[1] Recorded track: "+e)}):console.info("[0] Recorded track: "+e)}):this.recordRTC.stopRecording(function(e){console.info("Recorded track: "+e)}):console.warn("No recording found.")},KurentoTest.prototype.saveRecordingToDisk=function(e){if(this.recordRTC){var t=this.recordRTC.save(e);console.info(t)}else console.warn("No recording found.")},KurentoTest.prototype.openRecordingInNewTab=function(){this.recordRTC?window.open(this.recordRTC.toURL()):console.warn("No recording found.")},KurentoTest.prototype.recordingToData=function(){var e=this;if(e.recordRTC){var t=e.recordRTC.getBlob(),o=new window.FileReader;o.readAsDataURL(t),o.onloadend=function(){e.recordingData=o.result}}else console.warn("No recording found.")},KurentoTest.prototype.videoEvent=function(e){e||(e=window.event),kurentoTest.videoEventValue=e.type,console.info("videoEvent "+kurentoTest.videoEventValue);var t=document.getElementById("status");t&&(t.value=e.type)};var kurentoTest=new KurentoTest;
